var R=Object.create;var f=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var O=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var q=(a,e)=>{for(var t in e)f(a,t,{get:e[t],enumerable:!0})},E=(a,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of C(e))!$.call(a,n)&&n!==t&&f(a,n,{get:()=>e[n],enumerable:!(r=z(e,n))||r.enumerable});return a};var M=(a,e,t)=>(t=a!=null?R(O(a)):{},E(e||!a||!a.__esModule?f(t,"default",{value:a,enumerable:!0}):t,a)),A=a=>E(f({},"__esModule",{value:!0}),a);var B={};q(B,{Interval:()=>o,MusicXML:()=>K,Solmization:()=>m,Tone:()=>l,ToneRow:()=>y,ToneRowSolmized:()=>V,Tuning:()=>c});module.exports=A(B);var g=M(require("fraction.js"),1);function T(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function k(a,e=!1){return e?a.abs().compare(1)<0?a.inverse():a:a.abs().compare(1)>0?a.inverse():a}function x(a,e,t){let r=0,n=a.length-1;for(;r<=n;){let s=n+r>>1,i=t(e,a[s]);if(i>0)r=s+1;else if(i<0)n=s-1;else return s}return~r}function p(a,e){return(a%e+e)%e}function I(a,e){let t=1/e;return Math.round(a*t)/t}var d=M(require("fraction.js"),1),o=class a{constructor(e){this.ratio=e}get cents(){return 1200*Math.log2(this.ratio.valueOf())}get savarts(){return 1e3*Math.log10(this.ratio.valueOf())}difference(e){return new a(this.ratio.div(e.ratio))}static fromRatio(e){return new a(new d.default(e))}static fromCents(e){return new a(new d.default(Math.pow(2,e/1200)))}static fromSavarts(e){return new a(new d.default(Math.pow(10,e/1e3)))}static compare(e,t){return e.ratio.compare(t.ratio)}static JND=a.fromCents(5)};var c=class a{constructor(e,t){this.intervals=e;this.metadata=t;this.intervals.sort(o.compare),this.intervals[0].ratio.valueOf()!=1&&(this.intervals=[new o(new g.default(1)),...this.intervals])}static fromIntervals(e,t){return new a(e.map(r=>typeof r=="string"?new o(new g.default(r)):o.fromCents(r)),t)}_transposable;get transposable(){if(this._transposable!==void 0)return this._transposable;let e=this.intervals[1].difference(this.intervals[0]);return this._transposable=this.intervals.slice(1).every((t,r)=>{let n=t.difference(this.intervals[r]);return new o(k(n.difference(e).ratio,!0)).ratio.compare(o.JND.ratio)<0})}get steps(){return this.intervals.length-1}get octave(){return this.intervals[this.steps]}tune(e){return new o(this.intervals[e.pitchClass].ratio.mul(this.octave.ratio.pow(e.octave)))}nearest(e){let t=Math.floor(Math.log(e.ratio.valueOf())/Math.log(this.octave.ratio.valueOf())),r=new o(e.ratio.div(this.octave.ratio.pow(t))),n=x(this.intervals,r,o.compare);if(n>=0)return{tone:new l(this,n,t),interval:e,difference:new o(new g.default(1))};{let s=~n,i=Math.abs(this.intervals[s-1].difference(r).cents),u=Math.abs(this.intervals[s].difference(r).cents),v=i<u?s-1:s,b=new l(this,v,t),w=this.tune(b);return{tone:b,interval:w,difference:w.difference(e)}}}static fromEdo(e){return new a(Array.from(Array(e+1)).map((t,r)=>o.fromCents(1200/e*r)))}},l=class a{constructor(e,t,r){this.tuning=e;this.pitchClass=t;this.octave=r}get pitch(){return this.pitchClass+this.octave*this.tuning.steps}get tune(){return this.tuning.tune(this)}static fromPitch(e,t){return new a(e,p(t,e.steps),Math.floor(t/e.steps))}};var h=class{keyValueMap=new Map;valueKeyMap=new Map;get size(){return this.keyValueMap.size}[Symbol.toStringTag];[Symbol.iterator]=this.keyValueMap[Symbol.iterator];entries=()=>this.keyValueMap.entries();keys=()=>this.keyValueMap.keys();values=()=>this.keyValueMap.values();get=e=>this.keyValueMap.get(e);getKey=e=>this.valueKeyMap.get(e);getValue=e=>this.get(e);set=(e,t)=>{this.delete(e),this.keyValueMap.set(e,t);let r=this.valueKeyMap.get(t)||[];return this.valueKeyMap.set(t,[...r,e]),this};setKey=(e,t)=>this.set(t,e);setValue=(e,t)=>this.set(e,t);clear=()=>{this.keyValueMap.clear(),this.valueKeyMap.clear()};delete=e=>{if(this.has(e)){let t=this.keyValueMap.get(e);this.keyValueMap.delete(e);let r=this.valueKeyMap.get(t).filter(n=>n!==e);return r.length>0?this.valueKeyMap.set(t,r):this.valueKeyMap.delete(t),!0}return!1};deleteKey=e=>this.delete(e);deleteValue=e=>this.hasValue(e)?(this.valueKeyMap.get(e).forEach(t=>{this.delete(t)}),!0):!1;forEach=(e,t)=>{this.keyValueMap.forEach((r,n)=>{e.apply(t,[r,n,this])})};has=e=>this.keyValueMap.has(e);hasKey=e=>this.has(e);hasValue=e=>this.valueKeyMap.has(e);inspect=()=>{let e="Multimap {",t=0;return this.forEach((r,n)=>{t++,e+=""+n.toString()+" => "+r.toString(),t<this.size&&(e+=", ")}),e+="}",e}};var m=class{constructor(e,t,r){this.tuning=e;this.notes=t;this.accidentals=r;this.parseMap=new h,Object.keys(t).forEach(n=>{this.parseMap.set(n,t[n]),Object.keys(r).forEach(s=>{this.parseMap.set(`${n}${s}`,p(t[n]+r[s],e.steps))})}),this.nameMap=new h,Object.keys(t).forEach(n=>{let s=[0];this.nameMap.set(n,t[n]),Object.keys(r).forEach(i=>{s.includes(r[i])||(this.nameMap.set(`${n}${i}`,p(t[n]+r[i],e.steps)),s.push(r[i]))})}),this.regex=new RegExp("^("+Array.from(this.parseMap.keys()).map(T).join("|")+")(-?\\d)$","i")}regex;nameMap;parseMap;name(e){return[...this.nameMap.getKey(e.pitchClass)].sort((r,n)=>r.length-n.length).map(r=>`${r}${e.octave}`)}parse(e){let t=this.regex.exec(e);if(!t)throw new Error(`[Solmization.parse] Could not match note ${e}`);return new l(this.tuning,this.parseMap.get(t[1]),parseInt(t[2],10))}};var y=class a{constructor(e,t,r){this.tuning=e;this.tones=t;this.metadata=r;if(t.some((n,s)=>!!t.slice(s+1).find(i=>i.pitchClass===n.pitchClass)))throw Error("Found repeating pitch class in tone row.")}transpose(e){return new a(this.tuning,this.tones.map(t=>l.fromPitch(this.tuning,e.pitch+t.pitch)))}invert(e){return new a(this.tuning,this.tones.map(t=>l.fromPitch(this.tuning,e.pitch-t.pitch)))}reverse(){return new a(this.tuning,[...this.tones].reverse())}rotate(e){let t=e%this.tones.length;return new a(this.tuning,[...this.tones.slice(t),...this.tones.slice(0,t)])}monotonize(e=!1){return new a(this.tuning,this.tones.reduce((t,r)=>{let n=t.length>0?t[t.length-1]:r;return!e&&r.pitch<n.pitch?t.push(new l(this.tuning,r.pitchClass,n.octave+(r.pitchClass<n.pitchClass?1:0))):e&&r.pitch>n.pitch?t.push(new l(this.tuning,r.pitchClass,n.octave+(r.pitchClass>n.pitchClass?-1:0))):t.push(r),t},[]))}get pitches(){return this.tones.map(e=>e.pitch)}static fromPitches(e,t,r){return new a(e,t.map(n=>l.fromPitch(e,n)),r)}static fromPitchClasses(e,t,r,n){return new a(e,t.map(s=>new l(e,s,r)),n)}},V=class a extends y{constructor(t,r,n,s){super(t,n,s);this.tuning=t;this.solmization=r;this.tones=n;this.metadata=s}static fromToneRow(t,r){return new a(t.tuning,r,t.tones,t.metadata)}};var _=M(require("jstoxml"),1);var j={name:"scalextric",version:"0.8.0",description:"Like Unicode, but for music. One day.",type:"module",types:"./build/types/index.d.ts",exports:{import:"./build/scalextric.js",require:"./build/scalextric.cjs"},scripts:{build:"npm run build:esm && npm run build:cjs && npm run build:d.ts","build:esm":"esbuild src/index.ts --bundle --format=esm --minify --sourcemap --outfile=build/scalextric.js","build:cjs":"esbuild src/index.ts --bundle --platform=node --packages=external --minify --sourcemap --outfile=build/scalextric.cjs","build:d.ts":"tsc --emitDeclarationOnly --outDir build/types","build:chords":"python src/utils/chordtable/generate.py > data/chords.json && echo 'Generate data/chords.json file'","build:scala":'wget -q -O data/scales.zip http://huygens-fokker.org/docs/scales.zip && unzip -o data/scales.zip -d data/ && for f in data/scl/*; do iconv -f iso-8859-1 -t utf-8 "$f" -o "$f"; done',test:"npm run test:lint && npm run test:ts && npm run test:js","test:lint":"eslint src","test:ts":"node --import=tsx --test test/*.spec.ts","test:js":"node --test test/*.spec.js"},author:"Karim Ratib <karim.ratib@gmail.com> (https://github.com/infojunkie)",license:"GPL-3.0-only",devDependencies:{"@eslint/js":"^9.17.0","@types/jstoxml":"^2.0.4","@types/node":"^22.10.2",esbuild:"^0.24.0",eslint:"^9.17.0","ts-node":"^10.9.2",tsx:"^4.19.2",typescript:"^5.7.2","typescript-eslint":"^8.18.1","validate-with-xmllint":"^1.2.1"},dependencies:{"fraction.js":"^4.1.2",jstoxml:"^3.2.6"}};var{toXML:P}=_.default,S="4.0",K=class a{constructor(e,t,r={}){this.title=e;this.objects=t;this.options=Object.assign({},a.defaultOptions,r),this.reference=new m(c.fromEdo(12),{C:0,D:2,E:4,F:5,G:7,A:9,B:11},{})}static defaultOptions={divisions:768,time:{beats:4,beatType:4},tempo:60};static accidentals={"#":"sharp","\u266F":"sharp","\uE262":"sharp",n:"natural","\u266E":"natural","\uE261":"natural",b:"flat","\u266D":"flat","\uE260":"flat",x:"double-sharp","\u{1D12A}":"double-sharp","\uE263":"double-sharp","##":"sharp-sharp","\u266F\u266F":"sharp-sharp","\uE269":"sharp-sharp",bb:"flat-flat","\u266D\u266D":"flat-flat","\u{1D12B}":"flat-flat","\uE264":"flat-flat","n#":"natural-sharp","\u266E\u266F":"natural-sharp","\uE268":"natural-sharp",nb:"natural-flat","\u266E\u266D":"natural-flat","\uE267":"natural-flat","#x":"triple-sharp","\u266F\u{1D12A}":"triple-sharp","\uE265":"triple-sharp",bbb:"triple-flat","\u266D\u266D\u266D":"triple-flat","\uE266":"triple-flat","\uE280":"quarter-flat","\uE282":"quarter-sharp","\uE281":"three-quarters-flat","\uE283":"three-quarters-sharp","\uE275":"sharp-down","\uE274":"sharp-up","\uE273":"natural-down","\uE272":"natural-up","\uE271":"flat-down","\uE270":"flat-up","\uE277":"double-sharp-down","\uE276":"double-sharp-up","\uE279":"flat-flat-down","\uE278":"flat-flat-up","\uE27A":"arrow-down","\uE27B":"arrow-up","\uE446":"slash-quarter-sharp","\uE447":"slash-sharp","\uE442":"slash-flat","\uE440":"double-slash-flat","\uE443":"quarter-flat","\uE444":"quarter-sharp","\uE441":"flat","\uE445":"sharp","\uE450":"sharp-1","\uE451":"sharp-2","\uE452":"sharp-3","\uE453":"sharp-5","\uE454":"flat-1","\uE455":"flat-2","\uE456":"flat-3","\uE457":"flat-4","\uE461":"sori","\uE460":"koron"};static durations={8:"eighth",4:"quarter",2:"half",1:"whole"};options;reference;convert(){return P(this.convertDocument(),{header:`
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML ${S} Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
      `.trim(),indent:"  "})}convertDocument(){return{_name:"score-partwise",_attrs:{version:S},_content:[{work:{"work-title":this.title}},{identification:[{encoding:[{software:`@infojunkie/scalextric ${j.version}`},{"encoding-date":a.convertDate(new Date)}]}]},{"part-list":{_name:"score-part",_attrs:{id:"P1"},_content:{_name:"part-name",_attrs:{"print-object":"no"},_content:this.title}}},{_name:"part",_attrs:{id:"P1"},_content:this.convertObjects()}]}}convertObjects(){return this.objects.reduce((e,t,r)=>{let n=this.convertMeasure(e.length+1);e.push(n),r>0&&n._content.push({_name:"print",_attrs:{"new-system":"yes"}}),r===0&&n._content.push({attributes:[{divisions:this.options.divisions},{key:[{fifths:0},{mode:"major"}]},{time:[{beats:this.options.time.beats},{"beat-type":this.options.time.beatType}]},{clef:[{sign:"G"},{line:2}]}]},{_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":[{_name:"metronome",_attrs:{parentheses:"no"},_content:[{"beat-unit":a.durations[this.options.time.beatType]},{"per-minute":this.options.tempo}]}]},{_name:"sound",_attrs:{tempo:this.options.tempo}}]}),t.metadata&&n._content.push({_name:"direction",_attrs:{placement:"above"},_content:[{"direction-type":[{words:t.metadata.label}]}]});let s=0;if(t.tones.forEach((i,u)=>{n._content.push(this.convertNote(i,t)),s=(s+1)%this.options.time.beats,s===0&&u<t.tones.length-1&&(n=this.convertMeasure(e.length+1),e.push(n))}),s>0)for(;s++<this.options.time.beats;)n._content.push({_name:"note",_content:[{_name:"rest"},{duration:this.options.divisions},{type:a.durations[this.options.time.beatType]}]});return n._content.push(this.convertBar("right","light-light")),e},[])}convertBar(e,t){return{_name:"barline",_attrs:{location:e},_content:[{"bar-style":t}]}}convertMeasure(e){return{_name:"measure",_attrs:{number:e},_content:[]}}convertNote(e,t){let r=t.solmization.name(e)[0],n=r[0],s=this.convertAccidental(r.slice(1,-1)),i=r[r.length-1],u=this.reference.parse(`${n}${i}`),v=e.tune.difference(u.tune).cents,b=I(v/100,.05);return{_name:"note",_content:[{_name:"pitch",_content:[{step:n},{alter:b},{octave:i}]},{duration:this.options.divisions},{type:a.durations[this.options.time.beatType]},{...s&&s!=="other"&&{accidental:s}},{...s&&s==="other"&&{_name:"accidental",_content:s,_attrs:{smufl:r.slice(1,-1)}}}]}}convertAccidental(e){return e.length?e in a.accidentals?a.accidentals[e]:"other":null}static convertDate(e){return new Date(e.getTime()-e.getTimezoneOffset()*6e4).toISOString().split("T")[0]}};0&&(module.exports={Interval,MusicXML,Solmization,Tone,ToneRow,ToneRowSolmized,Tuning});
//# sourceMappingURL=scalextric.cjs.map
