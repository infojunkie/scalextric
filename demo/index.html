<!DOCTYPE html>
<html>
    <head>
        <title>Scalextric Demo</title>
        <style>
            body {
              background-color: wheat;
            }
            #player {
              position: fixed;
              bottom: 0;
              width: 100%;
              display: flex;
              justify-content: center;
              align-items: center;
              z-index: 1000;
            }
            .player {
              font-size: larger;
              margin: 5px;
              height: 35px;
              width: 35px;
            }
        </style>
        <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
        <script src="http://www.verovio.org/javascript/latest/verovio-toolkit-wasm.js" defer></script>
        <script src="dist/scalextric.js"></script>
        <script type="module">
            import * as MusicXMLPlayer from './node_modules/musicxml-player/dist/musicxml-player.esm.js';
            window.addEventListener("load", async () => {
                const edo12 = new Scalextric.Tuning(Scalextric.Tuning.intervalsEdo(12));
                const major = Scalextric.ToneRow.fromPitchClasses(edo12, [0, 2, 4, 5, 7, 9, 11, 12], 4, [new Scalextric.Annotation('label', 'Major scale')]);
                const minor = Scalextric.ToneRow.fromPitchClasses(edo12, [0, 2, 3, 5, 7, 9, 11, 12], 4, [new Scalextric.Annotation('label', 'Minor scale')]);
                const mxml = new Scalextric.MusicXML('Scalextric Demo', [major, minor]);
                const xml = mxml.convert();

                verovio.module.onRuntimeInitialized = async () => {
                    let vrv = new verovio.toolkit();
                    vrv.loadData(xml);
                    const midi = vrv.renderToMIDI();

                    function _base64ToArrayBuffer(base64) {
                        var binary_string = window.atob(base64);
                        var len = binary_string.length;
                        var bytes = new Uint8Array(len);
                        for (var i = 0; i < len; i++) {
                            bytes[i] = binary_string.charCodeAt(i);
                        }
                        return bytes.buffer;
                    }

                    const player = await MusicXMLPlayer.Player.load({
                        container: 'sheet',
                        renderer: MusicXMLPlayer.SheetRenderer.OpenSheetMusicDisplay,
                        musicXml: xml,
                        midiBuffer: _base64ToArrayBuffer(midi),
                    });
                    document.getElementById("play").addEventListener("click", async () => {
                        await player.play();
                    });
                    document.getElementById("pause").addEventListener("click", async () => {
                        await player.pause();
                    });
                    document.getElementById("rewind").addEventListener("click", async () => {
                        await player.rewind();
                    });
                }
            });
        </script>
    </head>
    <body>
        <div id="sheet"></div>
        <div id="player">
            <button class="player" id="rewind">⏮</button>
            <button class="player" id="pause">⏸</button>
            <button class="player" id="play">▶</button>
        </div>
    </body>
</html>
